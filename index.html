<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Last Fight</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --color-bg-main: #111827; /* gray-900 */
            --color-bg-card: #1f2937; /* gray-800 */
            --color-bg-header: #374151; /* gray-700 */
            --color-border: #4b5563; /* gray-600 */
            --color-text-main: #f3f4f6; /* gray-100 */
            --color-text-dim: #9ca3af; /* gray-400 */
            --color-accent-green: #10b981; /* green-500 */
            --color-accent-blue: #3b82f6; /* blue-500 */
            --color-accent-red: #ef4444; /* red-500 */
            --color-accent-yellow: #eab308; /* yellow-500 */
        }
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: var(--color-bg-main);
        }
        ::-webkit-scrollbar-thumb {
            background: var(--color-border);
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        /* Progress Box States */
        .progress-box {
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            user-select: none;
            transition: all 0.2s ease-in-out;
            color: white;
            border-radius: 8px;
            
            /* --- CRITICAL FIX (Bug #2): Fixed dimensions --- */
            width: 50px;
            min-width: 50px;
            max-width: 50px;
            height: 50px;
            flex-shrink: 0;
            /* --- End Fix --- */
            
            box-sizing: border-box; 
            border: 2px solid transparent;
        }
        .progress-0 { background-color: #4b5563; border-color: #4b5563; color: var(--color-text-main); }
        .progress-20 { background-color: #ef4444; border-color: #ef4444; } /* red-500 */
        .progress-40 { background-color: #f97316; border-color: #f97316; } /* orange-500 */
        .progress-60 { background-color: #eab308; border-color: #eab308; } /* yellow-500 */
        .progress-80 { background-color: #3b82f6; border-color: #3b82f6; } /* blue-500 */
        .progress-100 { background-color: #10b981; border-color: #10b981; } /* green-500 */
        
        .progress-box:hover {
            transform: scale(1.05);
        }

        /* Topic Item */
        .topic-item {
            display: flex;
            align-items: center;
            gap: 0.75rem; /* 12px */
            padding: 0.5rem; /* 8px */
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .topic-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .topic-name {
            flex-grow: 1;
            font-weight: 500;
            color: var(--color-text-main);
        }

        .edit-icon {
            flex-shrink: 0;
            color: var(--color-text-dim);
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
        }
        .edit-icon:hover {
            background-color: var(--color-border);
            color: white;
        }
        .edit-icon.has-note {
            color: var(--color-accent-yellow);
        }
        .edit-icon.has-note:hover {
            color: #fde047; /* yellow-300 */
        }

        /* Table Responsive */
        @media (max-width: 768px) {
            thead { display: none; }
            tr {
                display: block;
                margin-bottom: 1rem;
                border-radius: 8px;
                border: 1px solid var(--color-border);
                overflow: hidden;
            }
            td {
                display: block;
                text-align: right;
                padding-left: 50%;
                position: relative;
                border-bottom: 1px solid var(--color-border);
            }
            td:last-child {
                border-bottom: none;
            }
            td::before {
                content: attr(data-label);
                position: absolute;
                left: 0;
                width: 45%;
                padding: 0.75rem 1rem;
                text-align: left;
                font-weight: 600;
                color: var(--color-text-dim);
            }
            td[data-label="Date"] {
                padding-left: 0.75rem;
                text-align: left;
                background-color: var(--color-bg-header);
            }
            td[data-label="Date"]::before {
                display: none;
            }
        }

        /* Toast Notification */
        #toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 50px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
            transition: opacity 0.3s, transform 0.3s;
            opacity: 0;
            transform: translateY(20px);
        }
        /* --- CRITICAL FIX (Toast): Added .show definition --- */
        #toast.show {
            opacity: 1;
            transform: translateY(0);
        }
        /* --- End Fix --- */
        
        /* Spinner */
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        /* Dragging */
        .topic-item.dragging {
            opacity: 0.5;
            background: var(--color-bg-header);
            transform: scale(1.02);
        }
        .drag-over {
            border: 2px dashed var(--color-accent-blue);
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        /* ContentEditable placeholder */
        [contenteditable="true"]:empty:before {
            content: attr(placeholder);
            color: var(--color-text-dim);
            opacity: 0.7;
            pointer-events: none;
            display: block;
        }
        [contenteditable="true"]:focus {
            outline: 2px solid var(--color-accent-blue);
            border-radius: 4px;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);
        }
        
        /* Delete Row Button */
        .delete-row-btn {
            position: absolute;
            top: 0.75rem; /* 12px */
            right: 0.75rem; /* 12px */
            color: var(--color-text-dim);
            opacity: 0.3;
            transition: all 0.2s ease;
        }
        tr:hover .delete-row-btn {
            opacity: 1;
        }
        .delete-row-btn:hover {
            color: var(--color-accent-red);
            transform: scale(1.1);
        }
        td[data-label="Date"] {
            position: relative;
        }
        
    </style>
</head>
<body class="bg-gray-900 text-gray-200 font-sans p-4 md:p-8" ondragover="event.preventDefault()">

    <!-- Header -->
    <div class="max-w-7xl mx-auto">
        <div class="flex flex-col md:flex-row justify-between md:items-center gap-4 mb-6">
            <h1 class="text-4xl font-bold text-white">Last Fight <span class="text-green-500">Tracker</span></h1>
            <!-- Countdown Card -->
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg border border-gray-700">
                <h3 class="text-lg font-semibold text-center text-yellow-400 mb-2">Countdown to Dec 12, 2025</h3>
                <div id="countdown" class="flex justify-center gap-3 text-center">
                    <div>
                        <span id="days" class="text-3xl font-bold text-white">00</span>
                        <span class="block text-xs text-gray-400">Days</span>
                    </div>
                    <div>
                        <span id="hours" class="text-3xl font-bold text-white">00</span>
                        <span class="block text-xs text-gray-400">Hours</span>
                    </div>
                    <div>
                        <span id="minutes" class="text-3xl font-bold text-white">00</span>
                        <span class="block text-xs text-gray-400">Mins</span>
                    </div>
                    <div>
                        <span id="seconds" class="text-3xl font-bold text-white">00</span>
                        <span class="block text-xs text-gray-400">Secs</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loading / Content -->
        <div id="loading" class="text-center py-20">
            <div class="spinner" style="margin: 0 auto; width: 40px; height: 40px; border-width: 4px;"></div>
            <p class="mt-4 text-lg text-gray-400">Loading Dashboard...</p>
        </div>

        <div id="content" class="hidden">
            <!-- Overall Progress Bars -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <!-- Table 1 Progress -->
                <div class="bg-gray-800 p-5 rounded-lg shadow-lg border border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-lg font-semibold text-white">Overall Progress (Syllabus)</span>
                        <span id="overall-progress-text" class="text-lg font-bold text-green-400">0%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden">
                        <div id="overall-progress-bar" class="bg-green-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
                <!-- Table 2 Progress -->
                <div class="bg-gray-800 p-5 rounded-lg shadow-lg border border-gray-700">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-lg font-semibold text-white">Daily Progress (Plan)</span>
                        <span id="t2-overall-progress-text" class="text-lg font-bold text-blue-400">0%</span>
                    </div>
                    <div class="w-full bg-gray-700 rounded-full h-4 overflow-hidden">
                        <div id="t2-overall-progress-bar" class="bg-blue-500 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Table 1: Subject-wise Topics -->
            <div class="bg-gray-800 rounded-lg shadow-lg border border-gray-700 mb-8 overflow-hidden">
                <div class="p-4 md:p-6 border-b border-gray-700">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-2">
                        <h2 class="text-2xl font-semibold text-white">Table 1: Subject-wise Topics (Syllabus)</h2>
                        <span id="t1_task_counter" class="bg-green-500/20 text-green-300 text-sm font-semibold px-3 py-1 rounded-full opacity-0 transition-opacity">
                            0 / 0 Done
                        </span>
                    </div>
                </div>
                <table id="table1" class="w-full min-w-[700px]">
                    <thead class="bg-gray-700 text-left">
                        <tr>
                            <th class="p-4 font-semibold w-1/6">Date</th>
                            <th class="p-4 font-semibold w-1/6">
                                Phy
                                <div class="w-full bg-gray-600 rounded-full h-1.5 mt-1 overflow-hidden">
                                    <div id="t1_col_phy" class="bg-green-500 h-1.5 rounded-full transition-all" style="width: 0%"></div>
                                </div>
                            </th>
                            <th class="p-4 font-semibold w-1/6">
                                Chem
                                <div class="w-full bg-gray-600 rounded-full h-1.5 mt-1 overflow-hidden">
                                    <div id="t1_col_chem" class="bg-green-500 h-1.5 rounded-full transition-all" style="width: 0%"></div>
                                </div>
                            </th>
                            <th class="p-4 font-semibold w-1/6">
                                Bio
                                <div class="w-full bg-gray-600 rounded-full h-1.5 mt-1 overflow-hidden">
                                    <div id="t1_col_bio" class="bg-green-500 h-1.5 rounded-full transition-all" style="width: 0%"></div>
                                </div>
                            </th>
                            <th class="p-4 font-semibold w-1/6">
                                GK
                                <div class="w-full bg-gray-600 rounded-full h-1.5 mt-1 overflow-hidden">
                                    <div id="t1_col_gk" class="bg-green-500 h-1.5 rounded-full transition-all" style="width: 0%"></div>
                                </div>
                            </th>
                            <th class="p-4 font-semibold w-1/6">
                                English
                                <div class="w-full bg-gray-600 rounded-full h-1.5 mt-1 overflow-hidden">
                                    <div id="t1_col_english" class="bg-green-500 h-1.5 rounded-full transition-all" style="width: 0%"></div>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        <!-- Rows will be populated by JavaScript -->
                    </tbody>
                </table>
                <div class="p-4 bg-gray-800 border-t border-gray-700">
                    <button id="add-row-t1" class="w-full text-lg text-gray-400 hover:text-white font-semibold p-3 border-2 border-dashed border-gray-600 rounded-lg hover:border-gray-500 transition-colors">
                        + Add New Row
                    </button>
                </div>
            </div>

            <!-- Table 2: Daily Session Plan -->
            <div class="bg-gray-800 rounded-lg shadow-lg border border-gray-700 mb-8 overflow-hidden">
                <div class="p-4 md:p-6 border-b border-gray-700">
                    <div class="flex flex-col sm:flex-row justify-between sm:items-center gap-2">
                        <h2 class="text-2xl font-semibold text-white">Table 2: Daily Session Plan</h2>
                        <span id="t2_task_counter" class="bg-blue-500/20 text-blue-300 text-sm font-semibold px-3 py-1 rounded-full opacity-0 transition-opacity">
                            0 / 0 Done
                        </span>
                    </div>
                </div>
                <table id="table2" class="w-full min-w-[700px]">
                    <thead class="bg-gray-700 text-left">
                        <tr>
                            <th class="p-4 font-semibold w-1/5">Date</th>
                            <th class="p-4 font-semibold w-1/5">
                                Morning Session
                                <div class="w-full bg-gray-600 rounded-full h-1.5 mt-1 overflow-hidden">
                                    <div id="t2_col_morning" class="bg-blue-500 h-1.5 rounded-full transition-all" style="width: 0%"></div>
                                </div>
                            </th>
                            <th class="p-4 font-semibold w-1/5">
                                Noon Session
                                <div class="w-full bg-gray-600 rounded-full h-1.5 mt-1 overflow-hidden">
                                    <div id="t2_col_noon" class="bg-blue-500 h-1.5 rounded-full transition-all" style="width: 0%"></div>
                                </div>
                            </th>
                            <th class="p-4 font-semibold w-1/5">
                                Night Session
                                <div class="w-full bg-gray-600 rounded-full h-1.5 mt-1 overflow-hidden">
                                    <div id="t2_col_night" class="bg-blue-500 h-1.5 rounded-full transition-all" style="width: 0%"></div>
                                </div>
                            </th>
                            <th class="p-4 font-semibold w-1/5">
                                Secret Files
                                <div class="w-full bg-gray-600 rounded-full h-1.5 mt-1 overflow-hidden">
                                    <div id="t2_col_secret" class="bg-blue-500 h-1.5 rounded-full transition-all" style="width: 0%"></div>
                                </div>
                            </th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700">
                        <!-- Rows will be populated by JavaScript -->
                    </tbody>
                </table>
                <div class="p-4 bg-gray-800 border-t border-gray-700">
                    <button id="add-row-t2" class="w-full text-lg text-gray-400 hover:text-white font-semibold p-3 border-2 border-dashed border-gray-600 rounded-lg hover:border-gray-500 transition-colors">
                        + Add New Row
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="bg-gray-700 text-white">
        <div id="toast-spinner" class="spinner"></div>
        <span id="toast-message">Syncing...</span>
    </div>
    
    <!-- Add Topic Modal -->
    <div id="add-topic-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-40 flex items-center justify-center hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-2xl w-full max-w-md border border-gray-700">
            <h3 class="text-xl font-semibold mb-4">Add New Topic</h3>
            <div class="mb-4">
                <label for="add-topic-modal-name" class="block text-sm font-medium text-gray-300 mb-1">Topic Name</label>
                <input type="text" id="add-topic-modal-name" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="flex justify-end gap-3">
                <button id="add-topic-modal-cancel" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md transition-colors">Cancel</button>
                <button id="add-topic-modal-save" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 rounded-md transition-colors font-semibold">Save Topic</button>
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div id="edit-modal" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="bg-gray-800 p-6 rounded-lg shadow-2xl w-full max-w-lg border border-gray-700">
            <h3 class="text-xl font-semibold mb-4">Edit Topic</h3>
            <div class="mb-4">
                <label for="modal-topic-name" class="block text-sm font-medium text-gray-300 mb-1">Topic Name</label>
                <input type="text" id="modal-topic-name" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            <div class="mb-6">
                <label for="modal-topic-note" class="block text-sm font-medium text-gray-300 mb-1">Notes</label>
                <textarea id="modal-topic-note" rows="4" class="w-full p-2 bg-gray-700 border border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Add your notes here..."></textarea>
            </div>
            <div class="flex justify-between items-center">
                <button id="modal-delete" class="px-4 py-2 bg-red-700 hover:bg-red-600 text-white rounded-md transition-colors font-semibold">Delete Topic</button>
                <div class="flex gap-3">
                    <button id="modal-cancel" class="px-4 py-2 bg-gray-600 hover:bg-gray-500 rounded-md transition-colors">Cancel</button>
                    <button id="modal-save" class="px-4 py-2 bg-green-600 hover:bg-green-500 rounded-md transition-colors font-semibold">Save (Ctrl+Enter)</button>
                </div>
            </div>
        </div>
    </div>


    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, enableIndexedDbPersistence, terminate } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App State ---
        let db, auth, dbDocRef, unsubscribeSnapshot;
        let countdownInterval, saveTimeout;
        let isFirstLoad = true;
        let pendingChanges = false;
        
        const appData = {
            completedTopics: {}
        };
        
        // Static data structure
        const tableData = {
            "table1": {
                "28/10/2025": {
                    "Phy": ["Motion", "Work", "Gas"],
                    "Chem": ["Organic (2.0-2.11.2)"],
                    "Bio": ["Tissue", "Bryophyta", "JiboProjukti"],
                    "GK": [],
                    "English": ["Spelling", "Syn-Ant + Translation", "Appropriate Prep"]
                },
                "31/10/2025": {
                    "Phy": ["Voutojogot", "Gravity", "Jamitik", "Semiconductor", "Stir Torith", "Cholotorith"],
                    "Chem": ["Chemical Change", "Porimangoto", "Poribesh", "Orthonoitik"],
                    "Bio": ["Somonnoy full", "Soshon", "nognobiji"],
                    "GK": [],
                    "English": []
                },
                "02/11/2025": {
                    "Phy": ["Optics", "Modern", "Neuclear"],
                    "Chem": ["Organic 2.1.3--last"],
                    "Bio": ["Colon", "Dharabahikota"],
                    "GK": [],
                    "English": ["Group Verb", "Proverb", "Idioms and Phrases"]
                }
            },
            "table2": {
                "26/10/2025": {
                    "Morning Session": ["Tissue", "Bryophyta", "JiboProjukti"],
                    "Noon Session": ["গতিবিদ্যা"],
                    "Night Session": ["Organic (C+Meditrics)"],
                    "Secret Files": ["Tissue", "Bryophta", "JiboProjukti", "Gotibidda"]
                },
                "27/10/2025": {
                    "Morning Session": ["Gas", "Work Revision", "Secret Files"],
                    "Noon Session": ["Organic All Left Classes"],
                    "Night Session": ["Spelling (All)"],
                    "Secret Files": []
                },
                "28/10/2025": {
                    "Morning Session": ["Organic for Weekly."],
                    "Noon Session": ["Weekly Session"],
                    "Night Session": ["Gravity", "Cholotorith"],
                    "Secret Files": ["Gravity", "Cholotorith"]
                },
                "29/10/2025": {
                    "Morning Session": ["পরিমাণগত রসায়ন", "পরিবেশ রসায়ন"],
                    "Noon Session": ["অর্থনৈতিক রসায়ন – Class+Book"],
                    "Night Session": ["অর্থনৈতিক রসায়ন-MQB"],
                    "Secret Files": ["অর্থনৈতিক রসায়ন", "পরিমাণগত রসায়ন", "পরিবেশ রসায়ন"]
                },
                "30/10/2025": {
                    "Morning Session": ["Somonnoy full"],
                    "Noon Session": [],
                    "Night Session": ["Somonnoy MQB", "Monthly English"],
                    "Secret Files": ["Somonnoy, left exams"]
                },
                "31/10/2025": {
                    "Morning Session": ["revision"],
                    "Noon Session": ["exam"],
                    "Night Session": ["Neuclear---mqb", "Modern"],
                    "Secret Files": ["Neuclear Phy", "Modern"]
                },
                "01/11/2025": { // Corrected from 01/10
                    "Morning Session": ["Colon"],
                    "Noon Session": ["Dharabahikota"],
                    "Night Session": ["Mixed"],
                    "Secret Files": ["Colon", "dharabahikota"]
                },
                "02/11/2025": {
                    "Morning Session": ["Optics(Class)"],
                    "Noon Session": ["+MQB"],
                    "Night Session": ["Exam", "Remake rutine"], // Kept as one topic
                    "Secret Files": []
                }
            }
        };

        const progressSteps = [0, 20, 40, 60, 80, 100];

        // --- DOM Elements ---
        const loadingEl = document.getElementById('loading');
        const contentEl = document.getElementById('content');
        const modalEl = document.getElementById('edit-modal');
        const modalTopicName = document.getElementById('modal-topic-name');
        const modalTopicNote = document.getElementById('modal-topic-note');
        const addTopicModalEl = document.getElementById('add-topic-modal');
        const addTopicModalName = document.getElementById('add-topic-modal-name');

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initializeAppFirebase();
            startCountdown();
            setupGlobalEventListeners();
        });

        async function initializeAppFirebase() {
            try {
                // Use environment variables provided by the canvas, or fallback to default config
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                
                let firebaseConfig;
                if (typeof __firebase_config !== 'undefined') {
                    try {
                        firebaseConfig = JSON.parse(__firebase_config);
                    } catch (e) {
                        console.warn("Could not parse __firebase_config, using fallback");
                        firebaseConfig = null;
                    }
                }
                
                // **FIX: Fallback Firebase config**
                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    firebaseConfig = {
                        apiKey: "AIzaSyDTLhIkrW9qk6KPT_gTDibIiJeVwWYTowk",
                        authDomain: "my-study-dashboard.firebaseapp.com",
                        databaseURL: "https://my-study-dashboard-default-rtdb.firebaseio.com",
                        projectId: "my-study-dashboard",
                        storageBucket: "my-study-dashboard.firebasestorage.app",
                        messagingSenderId: "66307909031",
                        appId: "1:66307909031:web:a077b8cf1a046069f80282",
                        measurementId: "G-936WFWT6DY"
                    };
                }

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Enable offline persistence
                try {
                    await enableIndexedDbPersistence(db);
                } catch (err) {
                    console.warn("Offline persistence failed:", err.code);
                }

                await authenticateUser(initialAuthToken, appId);
                
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
                loadingEl.innerHTML = `<p class="text-red-400">Error: Could not initialize app. ${error.message}</p>`;
            }
        }

        async function authenticateUser(token, appId) {
            try {
                if (token) {
                    await signInWithCustomToken(auth, token);
                } else {
                    await signInAnonymously(auth);
                }
                
                const userId = auth.currentUser.uid;

                const docPath = `artifacts/${appId}/users/${userId}/studyProgress/data`;
                dbDocRef = doc(db, docPath);

                loadDataFromFirestore();

            } catch (error) {
                console.error("Authentication Error:", error);
                loadingEl.innerHTML = `<p class="text-red-400">Error: Authentication failed. ${error.message}</p>`;
            }
        }

        function loadDataFromFirestore() {
            if (!dbDocRef) return;
            showToast('syncing');
            if (unsubscribeSnapshot) unsubscribeSnapshot(); // Unsubscribe from old listener
            
            unsubscribeSnapshot = onSnapshot(dbDocRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    appData.completedTopics = data.completedTopics || {};
                    
                    if (data.tableData) {
                        const firestoreTableData = data.tableData;
                        Object.keys(firestoreTableData).forEach(tableId => {
                            if (!tableData[tableId]) tableData[tableId] = {};
                            // Merge dates from firestore with static dates
                            Object.keys(firestoreTableData[tableId]).forEach(date => {
                                tableData[tableId][date] = firestoreTableData[tableId][date];
                            });
                        });
                    }
                } else {
                    // No document, use static data
                    appData.completedTopics = {};
                }

                renderData();
                showToast(doc.metadata.fromCache ? "cached" : "synced");
                
            }, (error) => {
                console.error("Firestore snapshot error:", error);
                loadingEl.innerHTML = `<p class="text-red-400">Error: Failed to load data. Check console.</p>`;
                showToast('error');
            });
        }
        
        // --- Data Rendering ---

        function renderData() {
            if (isFirstLoad) {
                populateTables();
                isFirstLoad = false;
            } else {
                updateExistingTopics();
            }
            
            updateAllProgressBars();
            
            loadingEl.classList.add('hidden');
            contentEl.classList.remove('hidden');
        }

        /**
         * Populates both tables based on the static tableData structure.
         * This runs only once on the first load.
         */
        function populateTables() {
            Object.keys(tableData).forEach(tableId => {
                const table = document.getElementById(tableId);
                const tbody = table.querySelector('tbody');
                const data = tableData[tableId];
                if (!tbody || !data) return;

                tbody.innerHTML = ''; // Clear any existing rows

                // Get sorted dates (important for rows added dynamically)
                const dates = Object.keys(data).sort((a, b) => {
                    const dateA = new Date(a.split('/').reverse().join('-'));
                    const dateB = new Date(b.split('/').reverse().join('-'));
                    return dateA - dateB;
                });

                dates.forEach(date => {
                    const newRow = createTableRow(table, date, data[date]);
                    tbody.appendChild(newRow);
                });
            });
        }
        
        /**
         * Creates a single <tr> element for a table.
         */
        function createTableRow(table, date, dateData) {
            const tableId = table.id;
            const newRow = document.createElement('tr');
            newRow.className = 'divide-x divide-gray-700 relative'; // Added relative for delete btn
            
            // 1. Create Date Cell
            const dateCell = document.createElement('td');
            dateCell.className = 'p-4 align-top';
            dateCell.dataset.label = "Date";
            
            const dateDiv = document.createElement('div');
            dateDiv.className = 'font-semibold p-1 -m-1 rounded-md';
            dateDiv.textContent = date;
            dateDiv.contentEditable = "true";
            dateDiv.dataset.originalDate = date;
            dateDiv.dataset.label = "Date"; // <-- THE FIX (For blur event)
            dateDiv.setAttribute('placeholder', 'DD/MM/YYYY');
            
            dateCell.appendChild(dateDiv);
            dateCell.appendChild(createDeleteRowButton(newRow)); // Add delete button
            newRow.appendChild(dateCell);

            // 2. Create Topic Cells
            const headers = Array.from(table.querySelectorAll('thead th')).slice(1); // Skip Date
            headers.forEach(th => {
                const colName = th.textContent.trim().split('\n')[0]; // Get name like "Phy"
                const cell = document.createElement('td');
                cell.className = 'p-2 align-top';
                cell.dataset.label = colName;
                
                const topics = dateData[colName] || [];
                
                topics.forEach(topicName => {
                    const topicId = createTopicId(tableId, date, colName, topicName);
                    const topicEl = createTopicElement(topicId, topicName);
                    cell.appendChild(topicEl);
                });
                
                // 3. Add the "Add Topic" button
                cell.appendChild(createAddTopicButton());
                newRow.appendChild(cell);
            });
            
            return newRow;
        }

        /**
         * Updates existing DOM elements based on appData.
         * This runs on every snapshot update *after* the first load.
         */
        function updateExistingTopics() {
            document.querySelectorAll('.progress-box').forEach(box => {
                const topicId = box.dataset.topicId;
                const topicData = appData.completedTopics[topicId];
                
                if (topicData) {
                    const progress = topicData.progress || 0;
                    box.className = `progress-box progress-${progress}`;
                    box.textContent = `${progress}%`;
                    
                    // Update name
                    const nameEl = box.closest('.topic-item').querySelector('.topic-name');
                    if (nameEl && topicData.name) {
                        nameEl.textContent = topicData.name;
                    }
                    
                    // Update note icon
                    const iconEl = box.closest('.topic-item').querySelector('.edit-icon');
                    if (iconEl) {
                        iconEl.classList.toggle('has-note', !!topicData.note);
                    }
                } else {
                    // Topic exists in DOM but not in appData (should be 0%)
                    box.className = `progress-box progress-0`;
                    box.textContent = `0%`;
                    const iconEl = box.closest('.topic-item').querySelector('.edit-icon');
                    if (iconEl) iconEl.classList.remove('has-note');
                }
            });
        }
        
        /**
         * Helper to create a single topic element (box, name, icon)
         */
        function createTopicElement(topicId, topicName) {
            const topicData = appData.completedTopics[topicId] || {};
            const progress = topicData.progress || 0;
            const note = topicData.note || '';
            const displayName = topicData.name || topicName; // Use saved name if available

            const topicEl = document.createElement('div');
            topicEl.className = 'topic-item';
            topicEl.draggable = true;

            const progressBox = document.createElement('div');
            progressBox.className = `progress-box progress-${progress}`;
            progressBox.textContent = `${progress}%`;
            progressBox.dataset.topicId = topicId;
            
            const nameEl = document.createElement('span');
            nameEl.className = 'topic-name';
            nameEl.textContent = displayName;

            const editIcon = document.createElement('span');
            editIcon.className = 'edit-icon';
            if (note) {
                editIcon.classList.add('has-note');
            }
            editIcon.dataset.topicId = topicId;
            editIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`;

            topicEl.appendChild(progressBox);
            topicEl.appendChild(nameEl);
            topicEl.appendChild(editIcon);

            return topicEl;
        }

        /**
         * Helper to create an "+ Add Topic" button
         */
        function createAddTopicButton() {
            const addBtn = document.createElement('button');
            addBtn.className = 'add-topic-btn w-full text-left text-sm text-gray-500 hover:text-blue-400 p-2 border-2 border-dashed border-gray-700 rounded-md hover:border-blue-500 transition-colors mt-1';
            addBtn.textContent = '+ Add Topic';
            return addBtn;
        }
        
        /**
         * Helper to create a "Delete Row" button
         */
        function createDeleteRowButton(rowElement) {
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-row-btn'; // CSS handles styling
            deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg>`;
            deleteBtn.title = 'Delete Row';
            
            // Event listener is attached via delegation in setupGlobalEventListeners
            return deleteBtn;
        }
        
        /**
         * Helper to generate a unique topic ID
         */
        function createTopicId(tableId, date, colName, topicName) {
            const t = tableId.replace('table', 't');
            const d = date.replace(/\//g, '-'); // Use dashed date for ID
            const c = colName.toLowerCase().replace(/[^a-z0-9]/g, '');
            const n = topicName.toLowerCase().replace(/\s/g, '-').replace(/[^a-z0-9\-]/g, '');
            return `${t}_${d}_${c}_${n}`;
        }
        
        // --- Event Handlers (Setup) ---

        /**
         * Sets up all global event listeners using delegation.
         */
        function setupGlobalEventListeners() {
            const container = document.body;

            // Click Handler
            container.addEventListener('click', (e) => {
                const target = e.target;
                
                // Progress box click
                if (target.classList.contains('progress-box')) {
                    handleProgressClick(target, false);
                    return;
                }
                // Edit icon click
                if (target.closest('.edit-icon')) {
                    handleEditClick(target.closest('.edit-icon'));
                    return;
                }
                // Add topic button click
                if (target.classList.contains('add-topic-btn')) {
                    handleAddTopicClick(target);
                    return;
                }
                // Add row button click
                if (target.id === 'add-row-t1' || target.id === 'add-row-t2') {
                    addNewRow(target.id === 'add-row-t1' ? 'table1' : 'table2');
                    return;
                }
                // Delete row button click
                if (target.closest('.delete-row-btn')) {
                    handleDeleteRowClick(target.closest('.delete-row-btn'));
                    return;
                }
                
                // Modal Clicks
                if (target.id === 'modal-save') {
                    handleModalSave();
                    return;
                }
                if (target.id === 'modal-cancel' || (target.id === 'edit-modal' && target === modalEl)) {
                    modalEl.classList.add('hidden');
                    return;
                }
                if (target.id === 'modal-delete') {
                    handleModalDelete();
                    return;
                }
                if (target.id === 'add-topic-modal-save') {
                    handleModalAddSave();
                    return;
                }
                if (target.id === 'add-topic-modal-cancel' || (target.id === 'add-topic-modal' && target === addTopicModalEl)) {
                    addTopicModalEl.classList.add('hidden');
                    return;
                }
            });
            
            // Right-click for progress reversal
            container.addEventListener('contextmenu', (e) => {
                if (e.target.classList.contains('progress-box')) {
                    e.preventDefault();
                    handleProgressClick(e.target, true); // true for reverse
                }
            });
            
            // ContentEditable (Date) handlers
            container.addEventListener('focusin', (e) => {
                const target = e.target;
                if (target.contentEditable === 'true' && target.dataset.label === 'Date') {
                    target.dataset.originalDate = target.textContent.trim();
                }
            });
            container.addEventListener('blur', (e) => {
                const target = e.target;
                if (target.contentEditable === 'true' && target.dataset.label === 'Date') {
                    handleDateChange(target);
                }
            }, true); // Use capture to ensure blur fires
            
            // Drag and Drop handlers
            let draggedElement = null;
            container.addEventListener('dragstart', (e) => {
                if (e.target.classList.contains('topic-item')) {
                    draggedElement = e.target;
                    setTimeout(() => e.target.classList.add('dragging'), 0);
                }
            });
            container.addEventListener('dragend', (e) => {
                if (draggedElement) {
                    draggedElement.classList.remove('dragging');
                    draggedElement = null;
                }
            });
            container.addEventListener('dragenter', (e) => {
                const cell = e.target.closest('td[data-label]');
                if (cell && draggedElement) {
                    cell.classList.add('drag-over');
                }
            });
            container.addEventListener('dragleave', (e) => {
                const cell = e.target.closest('td[data-label]');
                if (cell) {
                    cell.classList.remove('drag-over');
                }
            });
            container.addEventListener('drop', (e) => {
                e.preventDefault();
                const cell = e.target.closest('td[data-label]');
                if (cell && draggedElement) {
                    cell.classList.remove('drag-over');
                    handleDragDrop(draggedElement, cell);
                }
            });
            
            // Modal Keyboard Accessibility
            document.addEventListener('keydown', (e) => {
                if (!modalEl.classList.contains('hidden')) {
                    if (e.key === 'Escape') {
                        modalEl.classList.add('hidden');
                    } else if (e.key === 'Enter' && e.ctrlKey) {
                        handleModalSave();
                    }
                }
                if (!addTopicModalEl.classList.contains('hidden')) {
                     if (e.key === 'Escape') {
                        addTopicModalEl.classList.add('hidden');
                    } else if (e.key === 'Enter') {
                        e.preventDefault(); // Prevent form submit
                        handleModalAddSave();
                    }
                }
            });
            
            // Cleanup listeners on page unload
            window.addEventListener('beforeunload', () => {
                if (countdownInterval) clearInterval(countdownInterval);
                if (saveTimeout) clearTimeout(saveTimeout);
                if (unsubscribeSnapshot) unsubscribeSnapshot();
            });
        }
        
        // --- Event Handler Logic ---

        /**
         * Handles clicking a progress box (left or right click).
         */
        function handleProgressClick(box, isReverse = false) {
            const topicId = box.dataset.topicId;
            if (!topicId) return;

            const currentProgress = appData.completedTopics[topicId]?.progress || 0;
            const currentIndex = progressSteps.indexOf(currentProgress);
            let nextIndex;
            
            if (isReverse) {
                nextIndex = (currentIndex - 1 + progressSteps.length) % progressSteps.length;
            } else {
                nextIndex = (currentIndex + 1) % progressSteps.length;
            }
            
            const newProgress = progressSteps[nextIndex];
            
            // Optimistic UI Update
            box.className = `progress-box progress-${newProgress}`;
            box.textContent = `${newProgress}%`;
            
            // Update local appData
            if (!appData.completedTopics[topicId]) {
                const nameEl = box.closest('.topic-item').querySelector('.topic-name');
                appData.completedTopics[topicId] = { 
                    progress: newProgress, 
                    note: '', 
                    name: nameEl ? nameEl.textContent : 'Unknown Topic' 
                };
            } else {
                appData.completedTopics[topicId].progress = newProgress;
            }
            
            saveDataToFirestore();
            updateProgressBarForCell(box.closest('td'));
        }
        
        /**
         * Opens the "Add Topic" modal.
         */
        function handleAddTopicClick(button) {
            const cell = button.closest('td');
            const row = cell.closest('tr');
            const table = cell.closest('table');
            const dateDiv = row.cells[0]?.querySelector('div');
            
            if (!dateDiv) return;
            const date = dateDiv.textContent.trim();
            if (date === 'New Date' || date === '') {
                alert("Please set a valid date for this row before adding topics.");
                dateDiv.focus();
                return;
            }
            
            const colName = cell.dataset.label;
            const tableId = table.id;
            
            addTopicModalEl.dataset.tableId = tableId;
            addTopicModalEl.dataset.colName = colName;
            addTopicModalEl.dataset.date = date; // Store slashed date
            addTopicModalName.value = '';
            addTopicModalEl.classList.remove('hidden');
            addTopicModalName.focus();
        }
        
        /**
         * Saves the new topic from the "Add Topic" modal.
         */
        function handleModalAddSave() {
            const tableId = addTopicModalEl.dataset.tableId;
            const colName = addTopicModalEl.dataset.colName;
            const date = addTopicModalEl.dataset.date; // Slashed date
            const newTopicName = addTopicModalName.value.trim();

            if (!newTopicName) {
                alert("Topic name cannot be empty.");
                return;
            }
            if (!tableId || !colName || !date) {
                console.error("Modal context is missing.");
                return;
            }

            const topicId = createTopicId(tableId, date, colName, newTopicName);
            
            if (appData.completedTopics[topicId] || document.querySelector(`[data-topic-id="${topicId}"]`)) {
                alert("A topic with this name already exists in this cell.");
                return;
            }

            // Find the correct cell
            const table = document.getElementById(tableId);
            let targetCell = null;
            const rows = table.querySelectorAll('tbody tr');
            for (const row of rows) {
                const dateDiv = row.cells[0]?.querySelector('div');
                if (dateDiv && dateDiv.textContent.trim() === date) {
                    targetCell = Array.from(row.cells).find(cell => cell.dataset.label === colName);
                    break;
                }
            }

            if (!targetCell) {
                console.error("Could not find target cell to add topic.");
                return;
            }
            
            if (!tableData[tableId][date]) {
                tableData[tableId][date] = {};
            }
            if (!tableData[tableId][date][colName]) {
                tableData[tableId][date][colName] = [];
            }
            tableData[tableId][date][colName].push(newTopicName);
            
            const topicEl = createTopicElement(topicId, newTopicName);
            const addBtn = targetCell.querySelector('.add-topic-btn');
            targetCell.insertBefore(topicEl, addBtn); // Insert before the button
            
            // Add to appData
            appData.completedTopics[topicId] = {
                progress: 0,
                note: '',
                name: newTopicName
            };
            
            saveDataToFirestore();
            updateProgressBarForCell(targetCell);
            addTopicModalEl.classList.add('hidden');
        }

        /**
         * Opens the "Edit Topic" modal.
         */
        function handleEditClick(iconEl) {
            const topicId = iconEl.dataset.topicId;
            
            if (!topicId) {
                console.error("No topic ID found on edit icon");
                return;
            }
            
            const currentData = appData.completedTopics[topicId] || {};
            const nameEl = iconEl.closest('.topic-item').querySelector('.topic-name');
            
            const defaultName = nameEl ? nameEl.textContent : '';
            const currentName = currentData.name || defaultName;
            const currentNote = currentData.note || '';
            
            modalEl.dataset.currentTopicId = topicId;
            modalTopicName.value = currentName;
            modalTopicNote.value = currentNote;
            modalEl.classList.remove('hidden');
            modalTopicName.focus();
        }

        /**
         * Saves changes from the "Edit Topic" modal.
         */
        function handleModalSave() {
            const topicId = modalEl.dataset.currentTopicId;
            if (!topicId) return;
            
            const newName = modalTopicName.value.trim();
            const newNote = modalTopicNote.value.trim();
            
            if (newName === '') {
                alert("Topic name cannot be empty.");
                return;
            }
            
            const currentData = appData.completedTopics[topicId] || { progress: 0 };
            
            const box = document.querySelector(`.progress-box[data-topic-id="${topicId}"]`);
            if (box) {
                const item = box.closest('.topic-item');
                const nameEl = item.querySelector('.topic-name');
                const oldName = nameEl ? nameEl.textContent : '';
                
                // If name changed significantly, we need to handle ID update
                if (oldName !== newName) {
                    const cell = item.closest('td');
                    const row = cell.closest('tr');
                    const table = cell.closest('table');
                    const dateDiv = row.cells[0]?.querySelector('div');
                    
                    if (dateDiv && table) {
                        const date = dateDiv.textContent.trim(); // Slashed date
                        const tableId = table.id;
                        const colName = cell.dataset.label;
                        
                        // Create new topic ID with new name
                        const newTopicId = createTopicId(tableId, date, colName, newName);
                        
                        // Check if new ID would conflict
                        if (newTopicId !== topicId && appData.completedTopics[newTopicId]) {
                            alert("A topic with this name already exists in this cell.");
                            return;
                        }
                        
                        // Update tableData
                        if (tableData[tableId] && tableData[tableId][date] && tableData[tableId][date][colName]) {
                            const topics = tableData[tableId][date][colName];
                            const index = topics.indexOf(oldName);
                            if (index > -1) {
                                topics[index] = newName;
                            }
                        }
                        
                        // Update DOM display
                        if (nameEl) nameEl.textContent = newName;
                        
                        // If ID changed, migrate data
                        if (newTopicId !== topicId) {
                            delete appData.completedTopics[topicId];
                            appData.completedTopics[newTopicId] = {
                                ...currentData,
                                name: newName,
                                note: newNote
                            };
                            
                            // Update DOM references
                            box.dataset.topicId = newTopicId;
                            const iconEl = item.querySelector('.edit-icon');
                            if (iconEl) iconEl.dataset.topicId = newTopicId;
                        } else {
                            appData.completedTopics[topicId] = {
                                ...currentData,
                                name: newName,
                                note: newNote
                            };
                        }
                    }
                } else {
                    // Name didn't change, just update note
                    appData.completedTopics[topicId] = {
                        ...currentData,
                        name: newName,
                        note: newNote
                    };
                }
                
                const iconEl = item.querySelector('.edit-icon');
                if (iconEl) iconEl.classList.toggle('has-note', !!newNote);
            }
            
            saveDataToFirestore();
            modalEl.classList.add('hidden');
        }

        /**
         * Deletes a topic from the "Edit Topic" modal.
         */
        function handleModalDelete() {
            const topicId = modalEl.dataset.currentTopicId;
            if (!topicId) return;
        
            if (!confirm("Are you sure you want to delete this topic?")) {
                return;
            }
            
            const progressBox = document.querySelector(`.progress-box[data-topic-id="${topicId}"]`);
            let cell = null;
            
            if (progressBox) {
                const topicElement = progressBox.closest('.topic-item');
                cell = topicElement.closest('td');
                
                // **FIX: Remove from tableData structure**
                const row = cell.closest('tr');
                const table = cell.closest('table');
                const dateDiv = row.cells[0]?.querySelector('div');
                
                if (dateDiv && table) {
                    const date = dateDiv.textContent.trim();
                    const tableId = table.id;
                    const colName = cell.dataset.label;
                    
                    // Get the actual topic name from the DOM
                    const topicNameEl = topicElement.querySelector('.topic-name');
                    const actualTopicName = topicNameEl ? topicNameEl.textContent : '';
        
                    if (tableData[tableId] && tableData[tableId][date] && tableData[tableId][date][colName]) {
                        const topics = tableData[tableId][date][colName];
                        const index = topics.indexOf(actualTopicName);
                        
                        if (index > -1) {
                            topics.splice(index, 1);
                        } else {
                            console.warn("Could not find topic in tableData to delete:", actualTopicName);
                        }
                    }
                }
                
                topicElement.remove(); 
            }
            
            delete appData.completedTopics[topicId];
            saveDataToFirestore();
            updateProgressBarForCell(cell);
            modalEl.classList.add('hidden');
        }

        /**
         * Adds a new, empty row to a table.
         */
        function addNewRow(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;
            
            const tbody = table.querySelector('tbody');
            const newRow = document.createElement('tr');
            newRow.className = 'divide-x divide-gray-700 relative';
            
            // 1. Create Date Cell
            const dateCell = document.createElement('td');
            dateCell.className = 'p-4 align-top';
            dateCell.dataset.label = "Date";
            
            const dateDiv = document.createElement('div');
            dateDiv.className = 'font-semibold p-1 -m-1 rounded-md';
            dateDiv.contentEditable = "true";
            dateDiv.dataset.originalDate = "New Date";
            dateDiv.dataset.label = "Date"; // For blur handler
            dateDiv.setAttribute('placeholder', 'DD/MM/YYYY');
            dateDiv.textContent = "New Date"; // Placeholder
            
            dateCell.appendChild(dateDiv);
            dateCell.appendChild(createDeleteRowButton(newRow));
            newRow.appendChild(dateCell);

            // 2. Create Empty Topic Cells
            const headers = Array.from(table.querySelectorAll('thead th')).slice(1);
            headers.forEach(th => {
                const colName = th.textContent.trim().split('\n')[0];
                const cell = document.createElement('td');
                cell.className = 'p-2 align-top';
                cell.dataset.label = colName;
                cell.appendChild(createAddTopicButton()); // Add button
                newRow.appendChild(cell);
            });
            
            tbody.appendChild(newRow);
            
            dateDiv.focus();
            const range = document.createRange();
            range.selectNodeContents(dateDiv);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
        }
        
        /**
         * Handles clicking the "Delete Row" button.
         */
        function handleDeleteRowClick(button) {
            const rowElement = button.closest('tr');
            if (!rowElement) return;
            
            if (confirm('Are you sure you want to delete this entire row? This cannot be undone.')) {
                
                const table = rowElement.closest('table');
                const dateDiv = rowElement.cells[0]?.querySelector('div');
                
                if (table && dateDiv) {
                    const tableId = table.id;
                    const date = dateDiv.textContent.trim();
                    if (tableData[tableId] && tableData[tableId][date]) {
                        delete tableData[tableId][date];
                    }
                }
                
                rowElement.querySelectorAll('.progress-box').forEach(box => {
                    delete appData.completedTopics[box.dataset.topicId];
                });
                rowElement.remove();
                saveDataToFirestore();
                updateAllProgressBars(); 
            }
        }
        
        /**
         * Handles validation and saving when a date cell is changed.
         */
        function handleDateChange(dateDiv) {
            const row = dateDiv.closest('tr');
            const table = row.closest('table');
            const newDate = dateDiv.textContent.trim(); // Slashed date, e.g., "28/10/2025"
            const oldDate = dateDiv.dataset.originalDate;
            
            if (!row || !table || !newDate || newDate === oldDate) {
                if (newDate !== oldDate) dateDiv.textContent = oldDate; // Revert if invalid
                return;
            }
            
            const dateRegex = /^\d{2}\/\d{2}\/\d{4}$/;
            if (!dateRegex.test(newDate)) {
                alert('Please enter a valid date in DD/MM/YYYY format');
                dateDiv.textContent = oldDate;
                return;
            }
            
            const [day, month, year] = newDate.split('/').map(Number);
            const testDate = new Date(year, month - 1, day);
            if (testDate.getDate() !== day || testDate.getMonth() !== month - 1 || testDate.getFullYear() !== year) {
                alert('Invalid date! Please check the day/month/year values.');
                dateDiv.textContent = oldDate;
                return;
            }
            
            const allDateCells = table.querySelectorAll('tbody tr td:first-child div');
            const existingDates = Array.from(allDateCells)
                .filter(cell => cell !== dateDiv)
                .map(cell => cell.textContent.trim());
            
            if (existingDates.includes(newDate)) {
                alert('A row with this date already exists!');
                dateDiv.textContent = oldDate;
                return;
            }
            
            dateDiv.dataset.originalDate = newDate; // Set new original date
            const tableId = table.id;
            
            if (tableData[tableId][oldDate]) {
                // This was an existing row, move its data
                tableData[tableId][newDate] = tableData[tableId][oldDate];
                delete tableData[tableId][oldDate];
            } else {
                // This was a new row ("New Date"), initialize it
                tableData[tableId][newDate] = {};
                const headers = Array.from(table.querySelectorAll('thead th'));
                headers.forEach((header, index) => {
                    if (index === 0) return;
                    const colName = header.textContent.trim().split('\n')[0];
                    tableData[tableId][newDate][colName] = [];
                });
            }

            // Now, update topic IDs which use dashed dates
            const newDateDashed = newDate.replace(/\//g, '-');

            row.querySelectorAll('.progress-box').forEach(box => {
                const topicId = box.dataset.topicId;
                const oldData = appData.completedTopics[topicId];
                if (!oldData) return;
                
                const parts = topicId.split('_');
                if (parts.length < 4) return;
                
                const tablePart = parts[0];     
                const colPart = parts[2];     
                const topicPart = parts.slice(3).join('_'); // Everything after column
                
                const newTopicId = `${tablePart}_${newDateDashed}_${colPart}_${topicPart}`;

                if (newTopicId !== topicId) {
                    delete appData.completedTopics[topicId];
                    appData.completedTopics[newTopicId] = oldData;
                    box.dataset.topicId = newTopicId; // Update DOM
                    const icon = box.closest('.topic-item').querySelector('.edit-icon');
                    if (icon) icon.dataset.topicId = newTopicId;
                }
            });
            
            saveDataToFirestore();
            
            dateDiv.style.borderColor = 'var(--color-accent-green)';
            setTimeout(() => {
                dateDiv.style.borderColor = '';
            }, 1000);
        }

        /**
         * Handles dragging and dropping a topic item.
         */
        function handleDragDrop(draggedElement, toCell) {
            const oldCell = draggedElement.closest('td');
            if (oldCell === toCell) return; // Dropped in the same cell
        
            // Get info for new ID
            const newRow = toCell.closest('tr');
            const newTable = toCell.closest('table');
            const newDateCell = newRow.cells[0]?.querySelector('div');
            if (!newDateCell) return;
            
            const newDate = newDateCell.textContent.trim();
            if (newDate === 'New Date') {
                alert("Cannot drop topic into a row with an unsaved date.");
                return;
            }
            
            const newColName = toCell.dataset.label;
            const newTableId = newTable.id;
        
            // Get old cell info
            const oldRow = oldCell.closest('tr');
            const oldTable = oldCell.closest('table');
            const oldDateCell = oldRow.cells[0]?.querySelector('div');
            const oldDate = oldDateCell ? oldDateCell.textContent.trim() : '';
            const oldColName = oldCell.dataset.label;
            const oldTableId = oldTable.id;
        
            const progressBox = draggedElement.querySelector('.progress-box');
            const oldTopicId = progressBox.dataset.topicId;
            const oldData = appData.completedTopics[oldTopicId];
            const topicNameEl = draggedElement.querySelector('.topic-name');
            const topicName = topicNameEl ? topicNameEl.textContent : '';
            
            const newTopicId = createTopicId(newTableId, newDate, newColName, topicName);
            
            if (oldTopicId === newTopicId) {
                return; // Same location, do nothing
            }
            
            if (appData.completedTopics[newTopicId] || document.querySelector(`[data-topic-id="${newTopicId}"]`)) {
                alert("A topic with this name already exists in the target cell.");
                return;
            }
        
            // Update tableData structure
            // Remove from old location
            if (tableData[oldTableId] && tableData[oldTableId][oldDate] && tableData[oldTableId][oldDate][oldColName]) {
                const topics = tableData[oldTableId][oldDate][oldColName];
                const index = topics.indexOf(topicName);
                if (index > -1) {
                    topics.splice(index, 1);
                }
            }
            
            // Add to new location
            if (!tableData[newTableId][newDate]) {
                tableData[newTableId][newDate] = {};
            }
            if (!tableData[newTableId][newDate][newColName]) {
                tableData[newTableId][newDate][newColName] = [];
            }
            // Check for duplicate before adding
            if (!tableData[newTableId][newDate][newColName].includes(topicName)) {
                tableData[newTableId][newDate][newColName].push(topicName);
            }
        
            // Update appData
            delete appData.completedTopics[oldTopicId];
            appData.completedTopics[newTopicId] = oldData;
            
            // Update DOM
            progressBox.dataset.topicId = newTopicId;
            const editIcon = draggedElement.querySelector('.edit-icon');
            if (editIcon) editIcon.dataset.topicId = newTopicId;
            toCell.insertBefore(draggedElement, toCell.querySelector('.add-topic-btn'));
        
            saveDataToFirestore();
            updateProgressBarForCell(oldCell);
            updateProgressBarForCell(toCell);
        }

        // --- Progress Bar Functions ---
        
        /**
         * Updates all progress bars (Overall, Columns, Counters).
         */
        function updateAllProgressBars() {
            updateOverallProgress();
            updateTable2Progress();
            updateColumnProgressBars('table1');
            updateColumnProgressBars('table2');
            updateTaskCounters();
        }
        
        /**
         * Updates progress for a single cell and bubbles up.
         */
        function updateProgressBarForCell(cellElement) {
            if (!cellElement || !cellElement.dataset) return;
            
            const table = cellElement.closest('table');
            if (!table) return;

            updateAllProgressBars(); // Simple way to ensure everything recalculates
        }

        /**
         * Updates the main "Overall Progress" bar (Table 1 only).
         */
        function updateOverallProgress() {
            const bar = document.getElementById('overall-progress-bar');
            const text = document.getElementById('overall-progress-text');
            if (!bar || !text) return;
            
            const table1 = document.getElementById('table1');
            if (!table1) return;
            
            const allBoxes = table1.querySelectorAll('.progress-box');
            const totalBoxes = allBoxes.length;

            if (totalBoxes === 0) {
                bar.style.width = '0%';
                text.textContent = '0%';
                return;
            }
            
            let totalProgress = 0;
            allBoxes.forEach(box => {
                const topicId = box.dataset.topicId;
                totalProgress += appData.completedTopics[topicId]?.progress || 0;
            });
            
            const overallAvg = (totalProgress / (totalBoxes * 100)) * 100;
            
            bar.style.width = `${overallAvg}%`;
            text.textContent = `${Math.round(overallAvg)}%`;
        }
        
        /**
         * Updates the secondary "Daily Progress" bar (Table 2 only).
         */
        function updateTable2Progress() {
            const bar = document.getElementById('t2-overall-progress-bar');
            const text = document.getElementById('t2-overall-progress-text');
            if (!bar || !text) return;
            
            const table2 = document.getElementById('table2');
            if (!table2) return;
            
            const allBoxes = table2.querySelectorAll('.progress-box');
            const totalBoxes = allBoxes.length;

            if (totalBoxes === 0) {
                bar.style.width = '0%';
                text.textContent = '0%';
                return;
            }
            
            let totalProgress = 0;
            allBoxes.forEach(box => {
                const topicId = box.dataset.topicId;
                totalProgress += appData.completedTopics[topicId]?.progress || 0;
            });
            
            const overallAvg = (totalProgress / (totalBoxes * 100)) * 100;
            
            bar.style.width = `${overallAvg}%`;
            text.textContent = `${Math.round(overallAvg)}%`;
        }

        /**
         * Updates all column-specific progress bars for a given table.
         */
        function updateColumnProgressBars(tableId) {
            const table = document.getElementById(tableId);
            if (!table) return;

            const headers = table.querySelectorAll('thead th');
            headers.forEach((th, colIndex) => {
                if (colIndex === 0) return; // Skip Date column
                
                let totalProgress = 0;
                let totalTopics = 0;
                const colLabel = th.textContent.trim().split('\n')[0];

                const rows = table.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    const cell = row.cells[colIndex];
                    if (cell) {
                        const boxes = cell.querySelectorAll('.progress-box');
                        boxes.forEach(box => {
                            const topicId = box.dataset.topicId;
                            totalProgress += appData.completedTopics[topicId]?.progress || 0;
                        });
                        totalTopics += boxes.length;
                    }
                });

                // Get column bar ID
                let colName = '';
                const thText = colLabel.toLowerCase();
                if (thText.includes('phy')) colName = 'phy';
                else if (thText.includes('chem')) colName = 'chem';
                else if (thText.includes('bio')) colName = 'bio';
                else if (thText.includes('gk')) colName = 'gk';
                else if (thText.includes('english')) colName = 'english';
                else if (thText.includes('morning')) colName = 'morning';
                else if (thText.includes('noon')) colName = 'noon';
                else if (thText.includes('night')) colName = 'night';
                else if (thText.includes('secret')) colName = 'secret';
                
                const progressBarId = `${tableId.replace('table', 't')}_col_${colName}`;
                const colBar = document.getElementById(progressBarId);

                if (colBar) {
                    if (totalTopics === 0) {
                        colBar.style.width = '0%';
                        colBar.classList.add('opacity-0'); // Hide
                    } else {
                        const avgProgress = (totalProgress / (totalTopics * 100)) * 100;
                        colBar.style.width = `${avgProgress}%`;
                        colBar.classList.remove('opacity-0'); // Show
                    }
                }
            });
        }
        
        /**
         * Updates the "X / Total Done" counters for both tables.
         */
        function updateTaskCounters() {
            ['table1', 'table2'].forEach(tableId => {
                const table = document.getElementById(tableId);
                const counterEl = document.getElementById(`${tableId.replace('table', 't')}_task_counter`);
                if (!table || !counterEl) return;
                
                const allBoxes = table.querySelectorAll('.progress-box');
                const totalTasks = allBoxes.length;
                let completedTasks = 0;
                
                allBoxes.forEach(box => {
                    const topicId = box.dataset.topicId;
                    if (appData.completedTopics[topicId]?.progress === 100) {
                        completedTasks++;
                    }
                });
                
                counterEl.textContent = `${completedTasks} / ${totalTasks} Done`;
                counterEl.classList.remove('opacity-0');
            });
        }

        // --- Utility Functions ---

        /**
         * Saves the current appData state to Firestore (debounced).
         */
        function saveDataToFirestore() {
            if (!dbDocRef) return;
            
            pendingChanges = true;
            if (saveTimeout) clearTimeout(saveTimeout);
            
            saveTimeout = setTimeout(async () => {
                if (!pendingChanges) return;
                pendingChanges = false;
                
                try {
                    showToast('syncing');
                    await setDoc(dbDocRef, { 
                        completedTopics: appData.completedTopics,
                        tableData: tableData  // Save tableData too
                    }, { merge: true });
                    // 'synced' toast is handled by onSnapshot
                } catch (error) {
                    console.error("Error saving to Firestore:", error);
                    showToast('error');
                    pendingChanges = true; // Retry on next call
                }
            }, 1000); 
        }
        
        /**
         * Shows a toast notification.
         */
        let toastTimeout;
        function showToast(type) {
            const toast = document.getElementById('toast');
            const msg = document.getElementById('toast-message');
            const spinner = document.getElementById('toast-spinner');
            if (!toast || !msg || !spinner) return;

            clearTimeout(toastTimeout);
            
            switch(type) {
                case 'syncing':
                    msg.textContent = 'Syncing...';
                    spinner.style.display = 'block';
                    toast.className = 'bg-blue-600 text-white';
                    break;
                case 'synced':
                    msg.textContent = 'Synced';
                    spinner.style.display = 'none';
                    toast.className = 'bg-green-600 text-white';
                    break;
                case 'cached':
                    msg.textContent = 'Offline (Cached)';
                    spinner.style.display = 'none';
                    toast.className = 'bg-yellow-500 text-gray-900';
                    break;
                case 'error':
                    msg.textContent = 'Sync Error';
                    spinner.style.display = 'none';
                    toast.className = 'bg-red-600 text-white';
                    break;
            }
            
            toast.classList.add('show');
            
            if (type !== 'syncing') {
                toastTimeout = setTimeout(() => {
                    toast.classList.remove('show');
                }, 2000);
            }
        }
        
        /**
         * Starts the countdown timer.
         */
        function startCountdown() {
            const daysEl = document.getElementById('days');
            const hoursEl = document.getElementById('hours');
            const minutesEl = document.getElementById('minutes');
            const secondsEl = document.getElementById('seconds');
            
            if (!daysEl || !hoursEl || !minutesEl || !secondsEl) return;
            
            const countDownDate = new Date("2025-12-12T00:00:00Z").getTime();

            countdownInterval = setInterval(() => {
                const now = new Date().getTime();
                const distance = countDownDate - now;

                if (distance < 0) {
                    clearInterval(countdownInterval);
                    daysEl.textContent = "00";
                    hoursEl.textContent = "00";
                    minutesEl.textContent = "00";
                    secondsEl.textContent = "00";
                    return;
                }

                const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((distance % (1000 * 60)) / 1000);

                daysEl.textContent = String(days).padStart(2, '0');
                hoursEl.textContent = String(hours).padStart(2, '0');
                minutesEl.textContent = String(minutes).padStart(2, '0');
                secondsEl.textContent = String(seconds).padStart(2, '0');
            }, 1000);
        }

    </script>
</body>
</html>

